# Universal Ticket Monitor

AI-powered ticket monitoring tool. Give it any ticketing URL, tell it what you're watching for, and it generates a parser plugin, polls the page, and sends you Telegram + macOS notifications when things change.

Built to track ICC T20 World Cup 2026 semi-final tickets on BookMyShow, but works with any ticketing site.

## How it works

1. You run `monitor.py add <url> --watch "what you care about"`
2. The tool fetches the page and sends the HTML to Gemini
3. Gemini generates a Python plugin that knows how to parse that site for your specific event
4. The plugin is saved to `plugins/` — next time you add a URL from the same site, it's reused instantly
5. `monitor.py run` polls all your watched URLs and alerts you on state changes

Plugins are pure parsers (no network access) validated via AST checks before saving. The framework handles all fetching (curl_cffi with Chrome TLS fingerprint, Playwright fallback for Cloudflare-protected sites).

## Quick start

```bash
# Clone and install
git clone https://github.com/yourusername/bms-cricket.git
cd bms-cricket
pip install -r requirements.txt
playwright install chromium  # optional, for Cloudflare-protected sites

# Configure
cp .env.example .env
# Edit .env with your API keys (see Configuration below)

# Add a URL to watch
python3 monitor.py add "https://in.bookmyshow.com/sports/india-icc-men-s-t20-wc-2026/ET00473676" \
  --watch "semi-final at Wankhede Stadium, Mumbai, Mar 4-5 2026"

# Start monitoring
python3 monitor.py run
```

## CLI

```bash
python3 monitor.py add <url>                          # AI analyzes page, generates plugin, adds to watchlist
python3 monitor.py add <url> --watch "description"    # Track a specific event on the page
python3 monitor.py list                               # Show all watched URLs + current state
python3 monitor.py remove <url>                       # Remove from watchlist
python3 monitor.py run                                # Start polling all watched URLs
```

### The `--watch` flag

Without `--watch`, the AI generates a generic "are tickets available" parser. With `--watch`, it generates a targeted plugin that looks for your specific event:

```bash
# Generic — detects any ticket availability on the page
python3 monitor.py add "https://example.com/events"

# Targeted — only tracks the specific event you care about
python3 monitor.py add "https://example.com/events" --watch "Taylor Swift Eras Tour, Madison Square Garden, June 15"
```

## Configuration

Copy `.env.example` to `.env` and fill in:

```
TELEGRAM_BOT_TOKEN=your_bot_token        # see setup_telegram.md
TELEGRAM_CHAT_ID=your_chat_id
GEMINI_API_KEY=your_gemini_api_key       # from https://aistudio.google.com/apikey
POLL_INTERVAL=60                          # seconds between checks
```

**Required:** `GEMINI_API_KEY` — needed to generate plugins for new sites.

**Optional:** Telegram credentials — without them, you still get macOS notifications and console logs.

## BMS-specific monitor

If you just want to monitor BookMyShow for T20 WC 2026 semi-finals without any AI setup:

```bash
python3 monitor_bms.py
```

This is the original hardcoded monitor — no Gemini API key needed, just Telegram credentials. It knows exactly what to look for (semi-finals at Wankhede, Mar 4-5) and polls every 60s.

## Project structure

```
monitor.py          CLI entrypoint (add, list, remove, run)
monitor_bms.py      Original BMS-specific monitor (standalone)
models.py           Shared types: TicketState, CheckResult, WatchEntry
config.py           .env loading, logging, constants
fetcher.py          Page fetching (curl_cffi + Playwright fallback)
notifier.py         Telegram + macOS notifications
analyzer.py         Gemini API: analyze HTML, generate plugin, validate
plugin_loader.py    Load/save/match plugins dynamically
watchlist.py        SQLite-backed watchlist CRUD
plugins/            AI-generated parser plugins (one .py per platform)
```

## How plugins work

Each plugin is a single `.py` file in `plugins/` with two exports:

```python
PLATFORM_PATTERNS = [r"https?://(?:[^/]+\.)?bookmyshow\.com/"]

def parse(html: str, url: str) -> CheckResult:
    # Parse the HTML and return the ticket state
    return CheckResult(state=TicketState.NOT_AVAILABLE, details="...", event_name="...")
```

Plugins are:
- **Generated by AI** from the actual page HTML
- **Validated via AST** — forbidden imports (os, subprocess) and dangerous calls (exec, eval) are blocked
- **Smoke tested** against the live page before saving
- **Reused automatically** — once a plugin exists for bookmyshow.com, any BMS URL uses it
- **Pure parsers** — no network access, only `re`, `json`, `html`, `html.parser`, `urllib.parse`

## Notifications

State changes trigger alerts via:
- **Telegram** — Markdown-formatted messages with direct booking links
- **macOS** — Desktop notifications with sound

States tracked: `UNKNOWN`, `NOT_AVAILABLE`, `COMING_SOON`, `AVAILABLE`, `SOLD_OUT`

## License

MIT
